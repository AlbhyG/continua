---
phase: 08-book-pdf-downloads
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/actions/verify-email.ts
  - src/app/verify/[token]/verification-form.tsx
  - src/components/dialogs/AgentsDialog.tsx
  - src/components/dialogs/TherapistsDialog.tsx
autonomous: false

must_haves:
  truths:
    - "After email verification, user sees a Download Book PDF button on the success page"
    - "Clicking the Download button triggers PDF download from /api/download/[book_type]?email=X"
    - "Agents dialog collects name and email with validation, triggers verification flow"
    - "Therapists dialog collects name and email with validation, triggers verification flow"
    - "User without verified email cannot download PDFs (Route Handler rejects with 403)"
  artifacts:
    - path: "src/app/actions/verify-email.ts"
      provides: "Updated verify action returning email and bookType on success"
      exports: ["verifyEmailAction"]
    - path: "src/app/verify/[token]/verification-form.tsx"
      provides: "Verification form with download link on success"
      contains: "/api/download/"
    - path: "src/components/dialogs/AgentsDialog.tsx"
      provides: "Agents dialog with email collection form and verification flow"
      contains: "requestVerificationAction"
    - path: "src/components/dialogs/TherapistsDialog.tsx"
      provides: "Therapists dialog with email collection form and verification flow"
      contains: "requestVerificationAction"
  key_links:
    - from: "src/app/actions/verify-email.ts"
      to: "verify_email_token RPC"
      via: "supabase.rpc call expecting email+book_type in response"
      pattern: "book_type"
    - from: "src/app/verify/[token]/verification-form.tsx"
      to: "/api/download/[book_type]"
      via: "anchor href with email query param"
      pattern: "/api/download/"
    - from: "src/components/dialogs/AgentsDialog.tsx"
      to: "src/app/actions/request-verification.ts"
      via: "useActionState bound to requestVerificationAction"
      pattern: "requestVerificationAction"
    - from: "src/components/dialogs/TherapistsDialog.tsx"
      to: "src/app/actions/request-verification.ts"
      via: "useActionState bound to requestVerificationAction"
      pattern: "requestVerificationAction"
---

<objective>
Wire the download link into the verification success page and update Agents/Therapists dialogs to use the same email collection + verification pattern as Publishers.

Purpose: Completes the user-facing flow so verified users can actually download PDFs, and extends the Book request flow to all three book types.

Output: Full end-to-end flow from any Book dialog through email verification to PDF download for all three book types.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-book-pdf-downloads/08-RESEARCH.md
@.planning/phases/08-book-pdf-downloads/08-01-SUMMARY.md
@src/app/actions/verify-email.ts
@src/app/verify/[token]/verification-form.tsx
@src/components/dialogs/PublishersDialog.tsx
@src/components/dialogs/AgentsDialog.tsx
@src/components/dialogs/TherapistsDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update verify-email action and verification form with download link</name>
  <files>
    src/app/actions/verify-email.ts
    src/app/verify/[token]/verification-form.tsx
  </files>
  <action>
**Update src/app/actions/verify-email.ts:**
- Update VerifyEmailState type to include optional `email` and `bookType` fields on success:
  ```typescript
  type VerifyEmailState = {
    success?: boolean
    error?: string
    email?: string
    bookType?: string
  } | null
  ```
- After the RPC call returns 'verified' status, extract `email` and `book_type` from the response JSON (the updated RPC from 08-01 now returns these)
- Return them in the success response: `{ success: true, email: result.email, bookType: result.book_type }`
- If email or book_type are missing from the RPC response (defensive), still return success but without download info

**Update src/app/verify/[token]/verification-form.tsx:**
- Update the success state to show a "Download Book PDF" link when state.email and state.bookType are present
- The link href should be: `/api/download/${state.bookType}?email=${encodeURIComponent(state.email)}`
- Use an `<a>` tag (not Next.js Link) since this is a file download, not a page navigation
- Add the `download` attribute to the anchor tag to hint browser download behavior
- Style the download button as a prominent CTA: rounded-full bg-accent text-white font-bold py-3 px-8 hover:bg-accent/90 transition-colors (matches existing button styles)
- Display book type name with first letter capitalized in button text: "Download Publishers Book PDF"
- Keep existing success text ("Email Verified!") but replace the generic "You'll be able to download your Book shortly" message with the download button
- If state.email or state.bookType are missing (edge case), fall back to the existing generic success message
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compiles. Verify verify-email.ts extracts email and bookType from RPC response. Verify verification-form.tsx renders download link with /api/download/ URL on success.
  </verify>
  <done>
Verification success page shows "Download [BookType] Book PDF" button linking to /api/download/[book_type]?email=X. verify-email action passes email and bookType from RPC response to frontend. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Agents and Therapists dialogs with verification flow</name>
  <files>
    src/components/dialogs/AgentsDialog.tsx
    src/components/dialogs/TherapistsDialog.tsx
  </files>
  <action>
**Update src/components/dialogs/AgentsDialog.tsx:**
- Copy the PublishersDialog pattern exactly (it's the proven working implementation from Phase 7)
- Import: useState, useEffect, useActionState from 'react'
- Import: Dialog, DialogBackdrop, DialogPanel, DialogTitle, Description from '@headlessui/react'
- Import: requestVerificationAction, type RequestVerificationState from '@/app/actions/request-verification'
- Import: signupSchema from '@/lib/validations/signup'
- Create SubmitButton component (same as Publishers)
- Add state management: values, touched, clientErrors (same pattern)
- Add validate, handleBlur, handleChange functions using signupSchema (same pattern)
- Reset form state on dialog close (useEffect on isOpen)
- Hidden input: `<input type="hidden" name="book_type" value="agents" />`
- Success view: "Check your email" confirmation with Close button
- Form view: Title "Agents Book", Description "Enter your information to receive the Agents Book. We'll send you a verification email to confirm your email address."
- Name and email fields with controlled inputs, blur+change validation, aria-invalid, aria-describedby
- Server error display for state.errors.form
- SubmitButton at bottom
- Remove the old phone number input field (v2.0 is email-only per project decision)

**Update src/components/dialogs/TherapistsDialog.tsx:**
- Same pattern as Agents, but with:
- Hidden input: `<input type="hidden" name="book_type" value="therapists" />`
- Title: "Therapists Book"
- Description: "Enter your information to receive the Therapists Book. We'll send you a verification email to confirm your email address."
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compiles. Verify both dialogs import requestVerificationAction. Verify both have hidden book_type inputs with correct values ('agents', 'therapists'). Verify both have name and email form fields with validation.
  </verify>
  <done>
Agents dialog has name+email form with book_type="agents", validation, and success view matching Publishers pattern. Therapists dialog has same pattern with book_type="therapists". Both use requestVerificationAction. Phone input removed from Agents. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end Book download verification</name>
  <what-built>
    Complete Book PDF download flow for all three book types:
    - Agents and Therapists dialogs now collect name+email and trigger verification
    - Verification success page shows "Download Book PDF" button
    - Download button links to authenticated Route Handler
    - Route Handler validates email, logs download, serves placeholder PDF
  </what-built>
  <how-to-verify>
    1. Navigate to the site and open the Publishers Book dialog
    2. Enter name and email, submit the form
    3. Verify "Check your email" confirmation appears
    4. Check email inbox for verification email from Continua
    5. Click the verification link in the email
    6. On the verification page, click "Verify Email" button
    7. Verify the success page shows "Download Publishers Book PDF" button
    8. Click the download button - verify a PDF file downloads
    9. Open the downloaded PDF - verify it's the placeholder content
    10. Try accessing /api/download/publishers?email=unverified@test.com - verify 403 response
    11. Try accessing /api/download/invalid?email=your@email.com - verify 400 response
    12. Open the Agents Book dialog - verify it has name+email form (no phone field)
    13. Open the Therapists Book dialog - verify it has name+email form
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors
2. verify-email action returns email and bookType on success
3. Verification success page shows download button with correct /api/download/ URL
4. Agents dialog matches Publishers pattern (name+email form, book_type="agents")
5. Therapists dialog matches Publishers pattern (name+email form, book_type="therapists")
6. End-to-end flow works: dialog -> email -> verify -> download PDF
7. Unauthorized access returns 403
</verification>

<success_criteria>
- Verified user sees and can click "Download Book PDF" button after verification
- PDF actually downloads when button clicked
- All three book dialogs (Publishers, Agents, Therapists) collect name+email and trigger verification
- Unverified users cannot access download endpoint (403)
- No TypeScript errors in build
</success_criteria>

<output>
After completion, create `.planning/phases/08-book-pdf-downloads/08-02-SUMMARY.md`
</output>
