---
phase: 07-email-verification-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00004_add_verification_columns.sql
  - src/lib/tokens/generate.ts
  - src/emails/verification-email.tsx
  - src/lib/email/send-verification.ts
  - .env.local.example
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Verification token can be generated as a 43-character base64url string"
    - "Database accepts verification_token and verification_token_expires_at values on contacts table"
    - "Branded verification email renders with recipient name, verification URL, and 24h expiry notice"
    - "Verification email can be sent via Resend using React Email template"
  artifacts:
    - path: "supabase/migrations/00004_add_verification_columns.sql"
      provides: "verification_token and verification_token_expires_at columns on contacts, RLS SELECT policy for token lookup, partial index"
      contains: "verification_token"
    - path: "src/lib/tokens/generate.ts"
      provides: "Cryptographically secure token generation"
      exports: ["generateVerificationToken", "isValidTokenFormat"]
    - path: "src/emails/verification-email.tsx"
      provides: "Branded React Email template for verification"
      exports: ["default"]
    - path: "src/lib/email/send-verification.ts"
      provides: "Email sending function using Resend + React Email"
      exports: ["sendVerificationEmail"]
  key_links:
    - from: "src/lib/email/send-verification.ts"
      to: "src/emails/verification-email.tsx"
      via: "import and render as react prop to resend.emails.send()"
      pattern: "react:\\s*VerificationEmail"
    - from: "src/lib/email/send-verification.ts"
      to: "src/lib/resend/client.ts"
      via: "import resend instance"
      pattern: "import.*resend.*from.*@/lib/resend/client"
---

<objective>
Create the backend infrastructure for email verification: database migration, token generation, branded email template, and email sending utility.

Purpose: Provide the foundation that Plan 02's Server Actions and verification page will consume.
Output: Migration SQL, token utility, React Email template, send-verification function.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-verification-flow/07-RESEARCH.md
@.planning/phases/05-supabase-foundation/05-02-SUMMARY.md
@.planning/phases/06-notification-signup/06-01-SUMMARY.md
@supabase/migrations/00001_create_contacts_and_book_requests.sql
@src/lib/resend/client.ts
@.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and token generation utility</name>
  <files>
    supabase/migrations/00004_add_verification_columns.sql
    src/lib/tokens/generate.ts
  </files>
  <action>
    **Database migration** (`supabase/migrations/00004_add_verification_columns.sql`):

    Add two columns to the existing `contacts` table:
    - `verification_token TEXT` (nullable — only set when verification is pending)
    - `verification_token_expires_at TIMESTAMPTZ` (nullable — paired with token)

    Add unique constraint on verification_token to prevent collisions:
    ```sql
    ALTER TABLE public.contacts
    ADD CONSTRAINT contacts_verification_token_unique UNIQUE (verification_token);
    ```

    Add partial index for fast token lookups (only indexes non-null tokens):
    ```sql
    CREATE INDEX idx_contacts_verification_token
    ON public.contacts (verification_token)
    WHERE verification_token IS NOT NULL;
    ```

    Add RLS SELECT policy for anon role to allow token lookup during verification:
    ```sql
    CREATE POLICY "Allow anonymous select by verification token"
      ON public.contacts
      FOR SELECT
      TO anon
      USING (verification_token IS NOT NULL);
    ```

    Note: The `email_verified` column already exists from migration 00001. Do NOT re-add it.

    Deploy migration: `npx supabase db push`

    **Token generation utility** (`src/lib/tokens/generate.ts`):

    Create two exported functions:
    1. `generateVerificationToken()`: Uses `crypto.randomBytes(32)` with `base64url` encoding. Returns a 43-character URL-safe string with 256 bits of entropy.
    2. `isValidTokenFormat(token: string)`: Validates token matches `/^[A-Za-z0-9_-]{43}$/` regex. Used by verification page to validate format before database lookup.

    Use Node.js built-in `crypto` module (import { randomBytes } from 'crypto'). Do NOT use Math.random(), UUID, or any other approach.
  </action>
  <verify>
    - `npx supabase db push` succeeds (migration applied)
    - `npx tsc --noEmit` passes (no type errors in token utility)
    - Token generation produces 43-character base64url strings
  </verify>
  <done>
    Database has verification_token and verification_token_expires_at columns with unique constraint, partial index, and anon SELECT policy. Token utility generates cryptographically secure 43-char tokens and validates format.
  </done>
</task>

<task type="auto">
  <name>Task 2: React Email template and send-verification utility</name>
  <files>
    src/emails/verification-email.tsx
    src/lib/email/send-verification.ts
    .env.local.example
    package.json
    package-lock.json
  </files>
  <action>
    **Install React Email:**
    ```bash
    npm install @react-email/components
    ```
    Note: Only install `@react-email/components` (the component library). The `react-email` dev server package is not needed for production use — Resend renders React Email components directly.

    **Branded email template** (`src/emails/verification-email.tsx`):

    Create a React Email component with these props:
    - `name: string` — recipient's name
    - `verificationUrl: string` — full URL to /verify/[token] page

    Template structure (use inline styles for email client compatibility):
    - White container with rounded corners on light gray background
    - Greeting: "Hi {name},"
    - Body text: "Thanks for your interest in The Personality Continua! Click the button below to verify your email address and access your Book download."
    - CTA button: "Verify Email Address" — purple background (#7C3AED), white text, pill shape (border-radius: 9999px), links to verificationUrl
    - Expiry notice: "This link will expire in 24 hours." (small, gray text)
    - Separator line
    - Footer: "If you didn't request this email, you can safely ignore it." (small, gray text)

    Import from `@react-email/components`: Html, Head, Body, Container, Section, Text, Button, Hr

    Export as default function `VerificationEmail`.

    **Send verification utility** (`src/lib/email/send-verification.ts`):

    Create `sendVerificationEmail` function accepting:
    ```typescript
    { to: string, name: string, token: string }
    ```

    Implementation:
    1. Build verification URL: `${process.env.NEXT_PUBLIC_SITE_URL}/verify/${token}`
    2. Import `resend` from `@/lib/resend/client`
    3. Import `VerificationEmail` from `@/emails/verification-email`
    4. Call `resend.emails.send()` with:
       - `from`: `process.env.RESEND_FROM_EMAIL!`
       - `to`: the email address
       - `subject`: "Verify your email — Continua"
       - `react`: `VerificationEmail({ name, verificationUrl })`
    5. If error, `console.error` and throw
    6. Return the Resend response data

    **Update .env.local.example:**
    Add `NEXT_PUBLIC_SITE_URL=http://localhost:3000` with comment explaining it's used for verification email links and must be set to production URL in deployment.
  </action>
  <verify>
    - `npm ls @react-email/components` shows package installed
    - `npx tsc --noEmit` passes (template and send utility compile without errors)
    - `npm run build` succeeds (no build errors from new files)
  </verify>
  <done>
    React Email verification template renders branded email with name, CTA button, and expiry notice. Send utility composes template with Resend client to deliver verification emails. NEXT_PUBLIC_SITE_URL documented in env example.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes — no TypeScript or build errors
2. `npx supabase db push` applied migration successfully
3. Token generation produces valid 43-character base64url strings
4. React Email template compiles and exports properly
5. Send verification function imports resend client and email template correctly
</verification>

<success_criteria>
- Database has verification_token, verification_token_expires_at columns with constraints and indexes
- RLS SELECT policy allows anonymous token lookup
- Token utility generates cryptographically secure tokens
- Branded email template uses React Email components with inline styles
- Email sending utility integrates Resend client with React Email template
- All existing routes still build as static
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-verification-flow/07-01-SUMMARY.md`
</output>
