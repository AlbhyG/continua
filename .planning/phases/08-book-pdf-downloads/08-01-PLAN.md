---
phase: 08-book-pdf-downloads
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00006_create_book_downloads_table.sql
  - supabase/migrations/00007_update_verify_email_function.sql
  - src/app/api/download/[book_type]/route.ts
  - private/books/publishers.pdf
  - private/books/agents.pdf
  - private/books/therapists.pdf
autonomous: true

must_haves:
  truths:
    - "Verified user hitting /api/download/publishers?email=X receives a PDF file download"
    - "Unverified user hitting /api/download/publishers?email=X receives 403 Forbidden"
    - "Missing or invalid book_type returns 400 Bad Request"
    - "Download request is logged to book_downloads table with contact_id, book_type, timestamp"
    - "PDF files are NOT accessible from /public/ (stored in /private/books/)"
  artifacts:
    - path: "supabase/migrations/00006_create_book_downloads_table.sql"
      provides: "Analytics table for tracking book downloads"
      contains: "CREATE TABLE public.book_downloads"
    - path: "supabase/migrations/00007_update_verify_email_function.sql"
      provides: "Updated RPC that returns email and book_type after verification"
      contains: "CREATE OR REPLACE FUNCTION verify_email_token"
    - path: "src/app/api/download/[book_type]/route.ts"
      provides: "Authenticated PDF download endpoint"
      exports: ["GET"]
    - path: "private/books/publishers.pdf"
      provides: "Placeholder PDF for Publishers book"
    - path: "private/books/agents.pdf"
      provides: "Placeholder PDF for Agents book"
    - path: "private/books/therapists.pdf"
      provides: "Placeholder PDF for Therapists book"
  key_links:
    - from: "src/app/api/download/[book_type]/route.ts"
      to: "supabase contacts table"
      via: "Supabase server client SELECT where email_verified=true"
      pattern: "email_verified"
    - from: "src/app/api/download/[book_type]/route.ts"
      to: "supabase book_downloads table"
      via: "INSERT to log download"
      pattern: "book_downloads.*insert"
    - from: "src/app/api/download/[book_type]/route.ts"
      to: "private/books/"
      via: "fs.readFile from private directory"
      pattern: "private.*books"
---

<objective>
Create the database migration for download analytics, update the verify_email_token RPC to return email and book_type, build the authenticated Route Handler for PDF serving, and add placeholder PDF files.

Purpose: Establishes the backend infrastructure for gated book downloads - the database table for analytics, the RPC enhancement for passing download context to the frontend, and the authenticated download endpoint.

Output: Working /api/download/[book_type]?email=X endpoint that validates email verification, logs downloads, and serves PDFs from /private/books/.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-book-pdf-downloads/08-RESEARCH.md
@.planning/phases/07-email-verification-flow/07-02-SUMMARY.md
@supabase/migrations/00001_create_contacts_and_book_requests.sql
@supabase/migrations/00005_add_verify_email_function.sql
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and RPC update</name>
  <files>
    supabase/migrations/00006_create_book_downloads_table.sql
    supabase/migrations/00007_update_verify_email_function.sql
  </files>
  <action>
Create two SQL migration files:

**00006_create_book_downloads_table.sql:**
- CREATE TABLE public.book_downloads with columns:
  - id BIGSERIAL PRIMARY KEY
  - contact_id BIGINT NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE
  - book_type TEXT NOT NULL CHECK (book_type IN ('publishers', 'agents', 'therapists'))
  - downloaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
- CREATE INDEX idx_book_downloads_contact_id ON book_downloads(contact_id)
- CREATE INDEX idx_book_downloads_book_type ON book_downloads(book_type)
- ALTER TABLE public.book_downloads ENABLE ROW LEVEL SECURITY
- Add RLS INSERT policy for anon role: the Route Handler in Task 2 calls `createClient()` from `@/lib/supabase/server` which uses `NEXT_PUBLIC_SUPABASE_ANON_KEY` (see server.ts line 9) â€” this is the **anon key, NOT service_role**. Therefore RLS policies are required for every table the Route Handler touches. Without an INSERT policy for anon, the download-logging INSERT will be silently rejected.
- Add RLS SELECT policy for anon role on contacts WHERE email_verified = true: the Route Handler needs to query contacts to check email_verified status using the same anon client. The existing RLS SELECT policy only allows select WHERE verification_token IS NOT NULL, which won't work after verification clears the token. This new policy lets the anon client read verified contacts for the download auth check.

**00007_update_verify_email_function.sql:**
- CREATE OR REPLACE FUNCTION verify_email_token(token_value TEXT) RETURNS JSON
- Keep existing logic (look up token, check expiry, mark verified, clear token)
- On success ('verified' status), also query book_requests table to find the most recent book_type for this contact (ORDER BY requested_at DESC LIMIT 1)
- On success, also include the contact's email in the response
- Return JSON: { status: 'verified', email: '...', book_type: 'publishers' } on success
- Unchanged JSON for 'invalid' and 'expired' statuses
- Keep SECURITY DEFINER, SET search_path = public
- Keep GRANT EXECUTE to anon

Deploy both migrations:
```
npx supabase db push
```
  </action>
  <verify>
Run `npx supabase db push` successfully. Verify book_downloads table exists and RPC returns email+book_type by checking migration syntax is valid SQL.
  </verify>
  <done>
book_downloads table exists with RLS enabled and INSERT policy for anon. contacts table has new SELECT policy for email_verified=true. verify_email_token RPC returns email and book_type on successful verification. Migrations deployed to Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Route Handler and placeholder PDFs</name>
  <files>
    src/app/api/download/[book_type]/route.ts
    private/books/publishers.pdf
    private/books/agents.pdf
    private/books/therapists.pdf
  </files>
  <action>
**Create placeholder PDF files:**
- Create directory `private/books/` at project root (same level as src/ and public/)
- Create three simple placeholder PDF files (publishers.pdf, agents.pdf, therapists.pdf). Use a minimal valid PDF structure - each file should contain the text "Continua [BookType] Book - Placeholder" so they are recognizable as placeholders. A minimal PDF is ~200 bytes. You can use a simple PDF generation approach or create minimal valid PDF binary content.

**Create Route Handler at src/app/api/download/[book_type]/route.ts:**
- Add `export const dynamic = 'force-dynamic'` to prevent caching
- Export GET handler with signature: `GET(req: NextRequest, { params }: { params: Promise<{ book_type: string }> })`
- Await params (Next.js 15 pattern): `const { book_type } = await params`
- Validate book_type is one of ['publishers', 'agents', 'therapists'], return 400 if invalid
- Extract email from query string: `req.nextUrl.searchParams.get('email')`, return 400 if missing
- Create Supabase client via `createClient()` from `@/lib/supabase/server`. **Important:** this returns an anon-key client (uses `NEXT_PUBLIC_SUPABASE_ANON_KEY`, NOT service_role). All database operations in this Route Handler go through RLS. The RLS policies created in Task 1 (SELECT on contacts WHERE email_verified=true, INSERT on book_downloads for anon) are **required** for these queries to succeed.
- Query contacts table: SELECT id, email_verified WHERE email = email.toLowerCase().trim() AND email_verified = true. Use .single(). If error or no data, return 403 'Unauthorized - email not verified'. (This query relies on the anon SELECT policy from Task 1.)
- Log download: INSERT into book_downloads { contact_id: data.id, book_type }. Log errors to console but do NOT block the download if logging fails. (This INSERT relies on the anon INSERT policy from Task 1.)
- Read PDF file: `const filePath = path.join(process.cwd(), 'private', 'books', \`${book_type}.pdf\`)`; use `fs.readFile(filePath)` from 'fs/promises'
- Return Response with the buffer, headers: Content-Type: application/pdf, Content-Disposition: `attachment; filename="continua-${book_type}-book.pdf"`, Content-Length: fileBuffer.length.toString()
- Wrap everything in try/catch, return 500 on unexpected errors
- Add security comment noting email parameter auth is acceptable for pre-launch placeholder PDFs

Import `NextRequest` from 'next/server', `createClient` from '@/lib/supabase/server', `fs` from 'fs/promises', `path` from 'path'.
  </action>
  <verify>
Run `npm run build` to confirm the route compiles and appears in build output as dynamic. Verify placeholder PDFs exist at private/books/*.pdf. Verify the route is NOT in /public/.
  </verify>
  <done>
Three placeholder PDFs exist in /private/books/. Route Handler at /api/download/[book_type] validates email verification via database lookup, logs downloads to book_downloads table, and serves PDFs with correct Content-Type and Content-Disposition headers. Build succeeds with route marked as dynamic.
  </done>
</task>

</tasks>

<verification>
1. `npx supabase db push` deploys without errors
2. `npm run build` succeeds with /api/download/[book_type] route visible in output
3. Placeholder PDFs exist at private/books/publishers.pdf, private/books/agents.pdf, private/books/therapists.pdf
4. Route Handler file exports GET function with force-dynamic
5. No PDF files exist in /public/ directory
</verification>

<success_criteria>
- book_downloads analytics table exists with RLS and INSERT policy
- verify_email_token RPC returns email and book_type on success
- Route Handler authenticates via email_verified database lookup before serving files
- Route Handler logs downloads to book_downloads table
- Placeholder PDFs served from /private/books/ (not /public/)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-book-pdf-downloads/08-01-SUMMARY.md`
</output>
