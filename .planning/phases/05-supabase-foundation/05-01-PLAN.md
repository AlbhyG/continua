---
phase: 05-supabase-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/middleware.ts
  - src/lib/resend/client.ts
  - .env.local.example
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Supabase client libraries are installed and importable"
    - "Three Supabase client variants exist for browser, server, and middleware contexts"
    - "Resend client is configured and importable for server-side email sending"
    - "Environment variable template documents all required secrets"
    - "All existing static routes build without errors after adding new dependencies"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser-side Supabase client using @supabase/ssr with cookie-based auth"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client for Server Components and Route Handlers"
      exports: ["createClient"]
    - path: "src/lib/supabase/middleware.ts"
      provides: "Middleware Supabase client for JWT token refresh"
      exports: ["updateSession"]
    - path: "src/lib/resend/client.ts"
      provides: "Resend SDK client instance for sending emails"
      exports: ["resend"]
    - path: ".env.local.example"
      provides: "Template documenting all required environment variables"
  key_links:
    - from: "src/lib/supabase/client.ts"
      to: "process.env.NEXT_PUBLIC_SUPABASE_URL"
      via: "environment variable read"
      pattern: "process\\.env\\.NEXT_PUBLIC_SUPABASE_URL"
    - from: "src/lib/supabase/server.ts"
      to: "@supabase/ssr"
      via: "createServerClient import"
      pattern: "createServerClient"
    - from: "src/lib/resend/client.ts"
      to: "process.env.RESEND_API_KEY"
      via: "environment variable read"
      pattern: "process\\.env\\.RESEND_API_KEY"
---

<objective>
Install Supabase and Resend packages, create client utility modules for all three execution contexts (browser, server, middleware), set up the Resend email client, and document required environment variables.

Purpose: Establish the foundational client libraries that all subsequent phases (6-8) will import for database access and email sending. This is pure plumbing — no UI, no routes, no user-facing changes.

Output: Four client utility modules under src/lib/, updated package.json, and .env.local.example template.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-supabase-foundation/05-RESEARCH.md
@package.json
@next.config.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase and Resend packages and create all client utilities</name>
  <files>
    package.json
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/middleware.ts
    src/lib/resend/client.ts
  </files>
  <action>
Run: `npm install @supabase/supabase-js @supabase/ssr resend`

Create `src/lib/supabase/client.ts` — Browser client for Client Components:
- Import `createBrowserClient` from `@supabase/ssr`
- Export a `createClient()` function that returns `createBrowserClient(NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY)`
- Use `process.env.NEXT_PUBLIC_SUPABASE_URL!` and `process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!` (non-null assertion is fine — app won't work without them)

Create `src/lib/supabase/server.ts` — Server client for Server Components and Route Handlers:
- Import `createServerClient` from `@supabase/ssr` and `cookies` from `next/headers`
- Export an async `createClient()` function that:
  1. Awaits `cookies()` to get the cookie store
  2. Returns `createServerClient(URL, ANON_KEY, { cookies: { getAll() returns cookieStore.getAll(), setAll(cookiesToSet) iterates and calls cookieStore.set() wrapped in try/catch (set fails in Server Components but works in Route Handlers) } })`

Create `src/lib/supabase/middleware.ts` — Middleware client for JWT refresh:
- Import `createServerClient` from `@supabase/ssr` and `NextResponse, NextRequest` from `next/server`
- Export an async `updateSession(request: NextRequest)` function that:
  1. Creates a `NextResponse.next()` response with forwarded request headers
  2. Creates a Supabase client with cookie handlers that read from `request.cookies` and write to both `request.cookies` and `response.cookies` (get, set, remove operations)
  3. Calls `await supabase.auth.getUser()` to refresh the session (use getUser() not getSession() per research — getUser() validates JWT with Supabase server, getSession() only reads from cookie without validation)
  4. Returns the response
- IMPORTANT: Use `getUser()` not `getSession()` or `getClaims()` — research says getClaims() but the current @supabase/ssr docs use getUser() for middleware. getUser() is the safest choice as it validates the JWT against the Supabase server.

Create `src/lib/resend/client.ts` — Resend email client:
- Import `Resend` from `resend`
- Export a `resend` instance: `new Resend(process.env.RESEND_API_KEY)`
- This is server-only — never import in Client Components
  </action>
  <verify>
Run `npm run build` — must succeed with zero errors. All existing pages (/, /who, /what) must still build as static routes.
Run `npx tsc --noEmit` — must pass type checking.
Confirm new files exist: `ls src/lib/supabase/ src/lib/resend/`
  </verify>
  <done>
Four client utility files exist under src/lib/ with correct exports. @supabase/supabase-js, @supabase/ssr, and resend are in package.json dependencies. Build passes with no errors and all existing routes remain static.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create environment variable template and verify build integrity</name>
  <files>
    .env.local.example
  </files>
  <action>
Create `.env.local.example` with all required environment variables documented:

```
# Supabase - Get these from https://supabase.com/dashboard/project/_/settings/api
NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here

# Resend - Get this from https://resend.com/api-keys
RESEND_API_KEY=re_your-api-key-here

# Email Configuration
RESEND_FROM_EMAIL=noreply@yourdomain.com
```

Notes in the file:
- NEXT_PUBLIC_ vars are exposed to the browser (safe — anon key is designed for client use with RLS)
- RESEND_API_KEY is server-only (never prefix with NEXT_PUBLIC_)
- RESEND_FROM_EMAIL must match a verified domain in Resend dashboard
- For local dev: copy this file to .env.local and fill in real values
- For Vercel: add these in Project Settings > Environment Variables

After creating the file, run `npm run build` one final time to confirm the full build pipeline passes. The build should succeed even without .env.local present (the client files reference env vars but aren't imported by any pages yet, so tree-shaking excludes them).
  </action>
  <verify>
Confirm `.env.local.example` exists and contains all 4 environment variables.
Confirm `.env.local.example` is NOT in .gitignore (it's a template, safe to commit).
Run `npm run build` — must pass. All routes must remain static.
  </verify>
  <done>
.env.local.example exists with documented NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, RESEND_API_KEY, and RESEND_FROM_EMAIL. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes — no TypeScript errors, no build failures
2. All existing routes (/, /who, /what) still generate as static pages
3. `src/lib/supabase/client.ts` exports createClient for browser use
4. `src/lib/supabase/server.ts` exports createClient for server use
5. `src/lib/supabase/middleware.ts` exports updateSession for JWT refresh
6. `src/lib/resend/client.ts` exports resend instance
7. `.env.local.example` documents all required environment variables
</verification>

<success_criteria>
- Three Supabase client utilities cover browser, server, and middleware contexts
- Resend client is ready for server-side email sending
- Environment variable template documents all secrets with source URLs
- Existing site builds and serves without any regressions
- No .env.local file committed (only .env.local.example template)
</success_criteria>

<output>
After completion, create `.planning/phases/05-supabase-foundation/05-01-SUMMARY.md`
</output>
